# 日报 - 2026-02-16

## 今日问题
- Fabric 1.20.1 客户端启动后出现中文方块字/中文语言异常。
- 日志关键报错：`Caught error loading resourcepacks, removing all selected resourcepacks`，根因异常为 `IllegalStateException: BlockModel parent has to be a block model`。

## 今日排查与结论
- 已确认 `zh_cn.json` 本身可解析，jar 内语言文件正常，问题不在语言文件编码。
- 语言异常是资源重载失败后的连带现象（资源包被回滚后，字体/语言表现异常）。
- 报错发生在 Fabric 模型加载阶段；当前 1.20.1 上 OBJ onload 链路存在兼容性问题，会触发整轮重载失败。

## 今日修复
1. 修复 `tile_icon` 作为 block model 时的非法 parent：
   - `common/src/main/resources/assets/hydronyasama/models/block/tile_icon.json`
   - 从 `item/handheld` 改为合法 block parent 与显式元素模型。
2. 增加 OBJ 委托模型的容错：
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - `getDependencies` / `resolveParents` 增加保护，避免单点异常直接中断。
3. 临时止血方案（本次最终生效）：
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
   - 暂时禁用 Fabric 1.20.1 的 OBJ onload 插件初始化，优先保证资源重载成功与中文正常显示。

## 构建验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过。
- 产物：`fabric-1.20.1/build/libs/HydroNyaSama-fabric-1.20.1-0.2.0.jar`

## 额外说明（log.gz）
- `.minecraft/logs` 是否生成压缩历史日志（`.log.gz`）由启动端日志系统配置决定（launcher/log4j 配置），并非本模组代码直接控制。
- 当前症状“仅 latest.log”通常是启动器日志滚动策略被关闭或未配置压缩归档。

## 下一步
- 在不影响资源重载稳定性的前提下，逐项恢复 Fabric 1.20.1 OBJ 功能：先做最小模型集白名单，再逐步放开。

## 修复补充（14:xx 稳定模式）
- 背景：用户反馈“进入世界后客户端渲染 NPE（Entity renderer null）+ 中文方格字回归”。
- 处理策略（稳定优先）：
  1) Fabric 1.20.1 客户端暂时关闭 OBJ onload 插件初始化（stability mode），避免进入世界后渲染链崩溃。
  2) 删除 `fabric-1.20.1` 下 21 个 `forge:obj` block model 覆盖文件，回退到 common 的普通模型，避免透明方块。
- 关键修改：
  - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
  - 删除 `fabric-1.20.1/src/main/resources/assets/hydronyasama/models/block/*.json` 中 21 个 `forge:obj` 覆盖文件（adsorption/ad_board/cuball/fluorescent/holo/led/mosaic/pillar/platform/station 系列）。
- 验证：`./gradlew.bat :fabric-1.20.1:build -x test` 通过。
- 当前取舍：先保证“中文正常 + 可进世界 + 方块可见”，OBJ 特效显示后续单独恢复（需逐项兼容验证）。

## 灰度恢复（14:xx 第二轮）
- 用户确认“稳定模式”下：中文恢复、可进存档、方块可见，但 OBJ 特效缺失。
- 新方案：进入 OBJ 灰度恢复模式（canary），仅放开 2 个方块的 OBJ：
  - `ad_board`
  - `cuball_lamp`
- 实施：
  1) Fabric 1.20.1 客户端恢复 OBJ 引导，但日志标记为 canary。
  2) `ObjModelResourceHandler120` 白名单缩减为仅上述 2 个 block path。
  3) 仅恢复 `fabric-1.20.1` 下这 2 个 `forge:obj` 模型覆盖 JSON。
- 构建：`./gradlew.bat :fabric-1.20.1:build -x test` 通过。
- 目标：确认“中文/进档稳定”前提下，逐步恢复 OBJ 可视化。

## 灰度回退（14:39 失败后）
- 用户日志确认：canary 模式下仍触发 `BlockModel parent has to be a block model`，并在进档后出现渲染 NPE。
- 结论：Fabric 1.20.1 当前 OBJ onload 链路仍不稳定，不能灰度上线。
- 处理：立即回退到稳定模式。
  - `BeaconProviderFabricClient` 再次禁用 OBJ 插件初始化。
  - 删除 canary 恢复的 2 个 OBJ 覆盖模型（`ad_board`、`cuball_lamp`）。
- 构建验证：`./gradlew.bat :fabric-1.20.1:build -x test` 通过。
- 当前状态：恢复“中文正常 + 可进档 + 非透明普通模型”的稳定基线。

## 参考模组实现分析（补充）
- 参考对象：`.reference/SpecialModelLoader-1.20`。
- 关键实现差异：
  1) `SMLModelResourceHandler` 不是只拦截单一模型 ID，而是把“在父链上命中特殊 loader 的模型”整体交给自定义加载器。
  2) `SpecialModelLoaderAPIImpl#loadModel` 会沿 `parent` 向上遍历，找到 loader 后把父链 JSON 反向合并（父 -> 子覆盖）再交给 OBJ loader。
  3) 这样可避免 vanilla 把“子模型当 BlockModel 解析、但其 parent 是自定义 UnbakedModel”导致的 `BlockModel parent has to be a block model`。
- 对照结论：
  - 我们此前仅拦截 `hydronyasama:block/ad_board`，但 `item/ad_board -> parent block/ad_board` 仍可能走到 vanilla 的 parent 校验路径，触发整轮资源重载回滚，连带中文显示异常。

## 按参考实现的修复（本轮）
1. `ObjModelResourceHandler120` 改为父链探测 + 合并加载：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - 新增逻辑：
     - 读取当前模型 JSON；
     - 若本体是 `forge:obj` 则直接加载；
     - 否则沿 `parent` 向上遍历，命中 OBJ 后将链路 JSON 合并，再统一走 OBJ 加载。
   - 仍保留 canary 白名单：仅允许 `hydronyasama:models/blocks/ad_board_base.obj`。
2. `ObjUnbakedModel120` 抽出可复用入口：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjUnbakedModel120.java`
   - 新增：
     - `isForgeObjModel(JsonObject)`
     - `getObjModelLocation(JsonObject)`
     - `tryLoadFromModelJson(ResourceManager, JsonObject)`
   - 使 handler 可直接对“合并后的模型 JSON”执行 OBJ 加载。

## 本轮构建验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。

## OBJ 扩容（用户确认稳定后）
- 用户反馈当前状态：中文正常、不崩溃、`ad_board` 正常。
- 本轮目标：在保持稳定的前提下扩大 OBJ 生效范围。

### 实施
1. 恢复此前临时删除的 Fabric 1.20.1 OBJ 模型定义（20 个）：
   - 路径：`fabric-1.20.1/src/main/resources/assets/hydronyasama/models/block/`
   - 代表文件：`cuball_lamp.json`、`station_lamp.json`、`platform_light_full.json`、`mosaic_light_multi.json` 等。
2. 放宽 handler 白名单策略：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - 从“仅 `ad_board_base.obj`”改为“允许 `hydronyasama:models/blocks/*.obj`”。
   - 仍保留 `namespace=hydronyasama` 约束，避免误拦截其他模组模型。
3. 父链合并逻辑保持不变（本轮继续沿用），用于规避 `BlockModel parent has to be a block model`。

### 验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。

## 物品栏图标发黑修复
- 用户反馈：OBJ 方块在物品栏中变成“淡黑一片”。
- 根因：
  - `common` 已提供独立 icon 物品模型（`parent=hydronyasama:block/tile_icon`）；
  - 但 `fabric-1.20.1` 存在同名 `models/item/*.json` 覆盖，将这些物品改为 `parent=hydronyasama:block/<obj_block>`，导致物品栏直接走 OBJ 网格渲染并出现发黑。
- 修复：
  - 删除 Fabric 1.20.1 下这批 21 个 item 覆盖文件，回退到 common 的 icon 模型。
  - 路径：`fabric-1.20.1/src/main/resources/assets/hydronyasama/models/item/`（ad_board/cuball/adsorption/fluorescent/holo/led/mosaic/pillar/platform/station 系列）。
- 验证：
  - 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
  - 结果：通过（BUILD SUCCESSFUL）。

## Fabric 1.18.2 OBJ 渲染补齐（按参考实现迁移）
- 背景：用户计划开始验证 `fabric-1.18.2`，要求先补齐 OBJ 渲染代码。
- 现状确认：
  - `fabric-1.18.2` 之前只有空壳 `ObjRenderClientBootstrap118`，未接入 model provider；
  - 资源中已有 `forge:obj` 模型 JSON，但客户端未解析，表现为 OBJ 不生效。

### 本轮实现
1. 新增 v118 OBJ 核心类（从 1.20.1 稳定版逻辑迁移，并按 1.18.2 API 适配）：
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjModelResourceHandler118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjUnbakedModel118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjModelOption118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjMeshBakedModel118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/CombinedObjUnbakedModel118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/CombinedObjBakedModel118.java`
2. 激活 1.18.2 客户端引导：
   - `ObjRenderClientBootstrap118#initialize()` 改为注册 `ObjModelResourceHandler118`。
3. 迁移的关键能力：
   - 沿 `parent` 链探测并合并 JSON（规避 `BlockModel parent has to be a block model` 类问题）；
   - 支持 `forge:obj`；
   - 自动叠加 `*_base.obj + *_light.obj` 双层渲染；
   - 限制仅拦截 `hydronyasama:models/blocks/*.obj`。
4. 1.18.2 物品图标策略同步：
   - 删除 `fabric-1.18.2` 下 21 个 item 覆盖（`parent=block/...`），回退到 common 的 `tile_icon` 2D icon。

### 构建验证
- 执行：`./gradlew.bat :fabric-1.18.2:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。

## 车站灯模型结论（station_lamp）
- 当前 `station_lamp` 在各端（Fabric/Forge）资源里都绑定 `station_lamp_mid.obj`，并非本轮误改。
- 参考源码（`.reference/NyaSamaOptics`）显示老实现是专用渲染器组合 5 个 OBJ：
  - `station_lamp_top.obj`
  - `station_lamp_mid.obj`
  - `station_lamp_end.obj`
  - `station_lamp_logo.obj`
  - `station_lamp_back.obj`
- 结论：你的判断是对的，现有“仅 mid”是简化方案，不是完整视觉方案；完整效果需要做“多 OBJ 组合渲染”。

## OBJ 光学白灯层补渲染（继续优化）
- 用户反馈：灰色底座已恢复，但记忆中应还有白色灯层，当前疑似漏渲染。
- 排查结论：
  1) 资源内存在大量成对模型：`*_base.obj` + `*_light.obj`；
  2) 现有 Fabric 覆盖 JSON 仅加载 `*_base.obj`；
  3) 当前 OBJ 资源缺少 `.mtl` 文件，单模型路径下所有面会回退到 `particle` 贴图，导致只见灰色外壳。

### 实施
1. 新增组合 Unbaked/Baked 模型（双层叠加）：
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/CombinedObjUnbakedModel120.java`
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/CombinedObjBakedModel120.java`
2. 在 OBJ handler 中自动补 light 层：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - 规则：
     - 当模型路径是 `..._base.obj` 且同目录存在 `..._light.obj` 时，
     - 自动加载第二层 light 模型并与 base 合并渲染；
     - light 层默认 `particle` 指向 `hydronyasama:block/light_base`。
3. 保持之前稳定措施不变：
   - 父链探测与 JSON 合并逻辑保留（用于规避 `BlockModel parent has to be a block model`）。

### 验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。
