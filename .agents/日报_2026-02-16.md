# 日报 - 2026-02-16

## 今日问题
- Fabric 1.20.1 客户端启动后出现中文方块字/中文语言异常。
- 日志关键报错：`Caught error loading resourcepacks, removing all selected resourcepacks`，根因异常为 `IllegalStateException: BlockModel parent has to be a block model`。

## 今日排查与结论
- 已确认 `zh_cn.json` 本身可解析，jar 内语言文件正常，问题不在语言文件编码。
- 语言异常是资源重载失败后的连带现象（资源包被回滚后，字体/语言表现异常）。
- 报错发生在 Fabric 模型加载阶段；当前 1.20.1 上 OBJ onload 链路存在兼容性问题，会触发整轮重载失败。

## 今日修复
1. 修复 `tile_icon` 作为 block model 时的非法 parent：
   - `common/src/main/resources/assets/hydronyasama/models/block/tile_icon.json`
   - 从 `item/handheld` 改为合法 block parent 与显式元素模型。
2. 增加 OBJ 委托模型的容错：
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - `getDependencies` / `resolveParents` 增加保护，避免单点异常直接中断。
3. 临时止血方案（本次最终生效）：
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
   - 暂时禁用 Fabric 1.20.1 的 OBJ onload 插件初始化，优先保证资源重载成功与中文正常显示。

## 构建验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过。
- 产物：`fabric-1.20.1/build/libs/HydroNyaSama-fabric-1.20.1-0.2.0.jar`

## 额外说明（log.gz）
- `.minecraft/logs` 是否生成压缩历史日志（`.log.gz`）由启动端日志系统配置决定（launcher/log4j 配置），并非本模组代码直接控制。
- 当前症状“仅 latest.log”通常是启动器日志滚动策略被关闭或未配置压缩归档。

## 下一步
- 在不影响资源重载稳定性的前提下，逐项恢复 Fabric 1.20.1 OBJ 功能：先做最小模型集白名单，再逐步放开。

## 修复补充（14:xx 稳定模式）
- 背景：用户反馈“进入世界后客户端渲染 NPE（Entity renderer null）+ 中文方格字回归”。
- 处理策略（稳定优先）：
  1) Fabric 1.20.1 客户端暂时关闭 OBJ onload 插件初始化（stability mode），避免进入世界后渲染链崩溃。
  2) 删除 `fabric-1.20.1` 下 21 个 `forge:obj` block model 覆盖文件，回退到 common 的普通模型，避免透明方块。
- 关键修改：
  - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
  - 删除 `fabric-1.20.1/src/main/resources/assets/hydronyasama/models/block/*.json` 中 21 个 `forge:obj` 覆盖文件（adsorption/ad_board/cuball/fluorescent/holo/led/mosaic/pillar/platform/station 系列）。
- 验证：`./gradlew.bat :fabric-1.20.1:build -x test` 通过。
- 当前取舍：先保证“中文正常 + 可进世界 + 方块可见”，OBJ 特效显示后续单独恢复（需逐项兼容验证）。

## 灰度恢复（14:xx 第二轮）
- 用户确认“稳定模式”下：中文恢复、可进存档、方块可见，但 OBJ 特效缺失。
- 新方案：进入 OBJ 灰度恢复模式（canary），仅放开 2 个方块的 OBJ：
  - `ad_board`
  - `cuball_lamp`
- 实施：
  1) Fabric 1.20.1 客户端恢复 OBJ 引导，但日志标记为 canary。
  2) `ObjModelResourceHandler120` 白名单缩减为仅上述 2 个 block path。
  3) 仅恢复 `fabric-1.20.1` 下这 2 个 `forge:obj` 模型覆盖 JSON。
- 构建：`./gradlew.bat :fabric-1.20.1:build -x test` 通过。
- 目标：确认“中文/进档稳定”前提下，逐步恢复 OBJ 可视化。

## 灰度回退（14:39 失败后）
- 用户日志确认：canary 模式下仍触发 `BlockModel parent has to be a block model`，并在进档后出现渲染 NPE。
- 结论：Fabric 1.20.1 当前 OBJ onload 链路仍不稳定，不能灰度上线。
- 处理：立即回退到稳定模式。
  - `BeaconProviderFabricClient` 再次禁用 OBJ 插件初始化。
  - 删除 canary 恢复的 2 个 OBJ 覆盖模型（`ad_board`、`cuball_lamp`）。
- 构建验证：`./gradlew.bat :fabric-1.20.1:build -x test` 通过。
- 当前状态：恢复“中文正常 + 可进档 + 非透明普通模型”的稳定基线。

## 参考模组实现分析（补充）
- 参考对象：`.reference/SpecialModelLoader-1.20`。
- 关键实现差异：
  1) `SMLModelResourceHandler` 不是只拦截单一模型 ID，而是把“在父链上命中特殊 loader 的模型”整体交给自定义加载器。
  2) `SpecialModelLoaderAPIImpl#loadModel` 会沿 `parent` 向上遍历，找到 loader 后把父链 JSON 反向合并（父 -> 子覆盖）再交给 OBJ loader。
  3) 这样可避免 vanilla 把“子模型当 BlockModel 解析、但其 parent 是自定义 UnbakedModel”导致的 `BlockModel parent has to be a block model`。
- 对照结论：
  - 我们此前仅拦截 `hydronyasama:block/ad_board`，但 `item/ad_board -> parent block/ad_board` 仍可能走到 vanilla 的 parent 校验路径，触发整轮资源重载回滚，连带中文显示异常。

## 按参考实现的修复（本轮）
1. `ObjModelResourceHandler120` 改为父链探测 + 合并加载：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - 新增逻辑：
     - 读取当前模型 JSON；
     - 若本体是 `forge:obj` 则直接加载；
     - 否则沿 `parent` 向上遍历，命中 OBJ 后将链路 JSON 合并，再统一走 OBJ 加载。
   - 仍保留 canary 白名单：仅允许 `hydronyasama:models/blocks/ad_board_base.obj`。
2. `ObjUnbakedModel120` 抽出可复用入口：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjUnbakedModel120.java`
   - 新增：
     - `isForgeObjModel(JsonObject)`
     - `getObjModelLocation(JsonObject)`
     - `tryLoadFromModelJson(ResourceManager, JsonObject)`
   - 使 handler 可直接对“合并后的模型 JSON”执行 OBJ 加载。

## 本轮构建验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。

## OBJ 扩容（用户确认稳定后）
- 用户反馈当前状态：中文正常、不崩溃、`ad_board` 正常。
- 本轮目标：在保持稳定的前提下扩大 OBJ 生效范围。

### 实施
1. 恢复此前临时删除的 Fabric 1.20.1 OBJ 模型定义（20 个）：
   - 路径：`fabric-1.20.1/src/main/resources/assets/hydronyasama/models/block/`
   - 代表文件：`cuball_lamp.json`、`station_lamp.json`、`platform_light_full.json`、`mosaic_light_multi.json` 等。
2. 放宽 handler 白名单策略：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - 从“仅 `ad_board_base.obj`”改为“允许 `hydronyasama:models/blocks/*.obj`”。
   - 仍保留 `namespace=hydronyasama` 约束，避免误拦截其他模组模型。
3. 父链合并逻辑保持不变（本轮继续沿用），用于规避 `BlockModel parent has to be a block model`。

### 验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。

## 物品栏图标发黑修复
- 用户反馈：OBJ 方块在物品栏中变成“淡黑一片”。
- 根因：
  - `common` 已提供独立 icon 物品模型（`parent=hydronyasama:block/tile_icon`）；
  - 但 `fabric-1.20.1` 存在同名 `models/item/*.json` 覆盖，将这些物品改为 `parent=hydronyasama:block/<obj_block>`，导致物品栏直接走 OBJ 网格渲染并出现发黑。
- 修复：
  - 删除 Fabric 1.20.1 下这批 21 个 item 覆盖文件，回退到 common 的 icon 模型。
  - 路径：`fabric-1.20.1/src/main/resources/assets/hydronyasama/models/item/`（ad_board/cuball/adsorption/fluorescent/holo/led/mosaic/pillar/platform/station 系列）。
- 验证：
  - 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
  - 结果：通过（BUILD SUCCESSFUL）。

## Fabric 1.18.2 OBJ 渲染补齐（按参考实现迁移）
- 背景：用户计划开始验证 `fabric-1.18.2`，要求先补齐 OBJ 渲染代码。
- 现状确认：
  - `fabric-1.18.2` 之前只有空壳 `ObjRenderClientBootstrap118`，未接入 model provider；
  - 资源中已有 `forge:obj` 模型 JSON，但客户端未解析，表现为 OBJ 不生效。

### 本轮实现
1. 新增 v118 OBJ 核心类（从 1.20.1 稳定版逻辑迁移，并按 1.18.2 API 适配）：
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjModelResourceHandler118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjUnbakedModel118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjModelOption118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjMeshBakedModel118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/CombinedObjUnbakedModel118.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/CombinedObjBakedModel118.java`
2. 激活 1.18.2 客户端引导：
   - `ObjRenderClientBootstrap118#initialize()` 改为注册 `ObjModelResourceHandler118`。
3. 迁移的关键能力：
   - 沿 `parent` 链探测并合并 JSON（规避 `BlockModel parent has to be a block model` 类问题）；
   - 支持 `forge:obj`；
   - 自动叠加 `*_base.obj + *_light.obj` 双层渲染；
   - 限制仅拦截 `hydronyasama:models/blocks/*.obj`。
4. 1.18.2 物品图标策略同步：
   - 删除 `fabric-1.18.2` 下 21 个 item 覆盖（`parent=block/...`），回退到 common 的 `tile_icon` 2D icon。

### 构建验证
- 执行：`./gradlew.bat :fabric-1.18.2:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。

## 车站灯模型结论（station_lamp）
- 当前 `station_lamp` 在各端（Fabric/Forge）资源里都绑定 `station_lamp_mid.obj`，并非本轮误改。
- 参考源码（`.reference/NyaSamaOptics`）显示老实现是专用渲染器组合 5 个 OBJ：
  - `station_lamp_top.obj`
  - `station_lamp_mid.obj`
  - `station_lamp_end.obj`
  - `station_lamp_logo.obj`
  - `station_lamp_back.obj`
- 结论：你的判断是对的，现有“仅 mid”是简化方案，不是完整视觉方案；完整效果需要做“多 OBJ 组合渲染”。

## 1.18.2 启动依赖冲突修正（17:42）
- 用户日志显示 `hydronyasama` 与 `fabric-api` 版本门槛冲突：
  - 模组声明要求 `fabric-api >=0.76.1+1.18.2`
  - 客户端实际为 `0.76.0+1.18.2`
- 修复：
  - `fabric-1.18.2/src/main/resources/fabric.mod.json`
  - `fabric-api` 依赖改为 `>=0.76.0+1.18.2`，与工程 1.18.2 目标版本保持一致。
- 验证：
  - `./gradlew.bat :fabric-1.18.2:build -x test` 通过。

## 透视问题 + 车站灯五模型（继续修复）
- 用户反馈（1.18.2）：`长明吸顶/日光/聚光灯、导向牌、大字壁` 贴邻方块时会出现“透视到底部”。
- 根因判断：这些是薄片/非满方块视觉，但 Fabric 注册为默认 `Block(props)`，会触发邻面错误剔除。

### 处理
1. 光学薄片方块改为 `noOcclusion`（Fabric）：
   - 文件：
     - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/content/FabricContentRegistrar.java`
     - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/content/FabricContentRegistrar.java`
   - 新增集合 `OPTICS_THIN_NO_OCCLUSION_BLOCK_IDS`，覆盖：
     - `adsorption_lamp` / `adsorption_lamp_mid` / `adsorption_lamp_up`
     - `fluorescent_lamp` / `spot_light`
     - `text_wall` / `text_wall_lit`
     - `guide_board_np/sp/dp` 及 `*_lit`
   - 对这些 id 的 `simple_block` 返回 `new Block(props.noOcclusion())`。
2. 车站灯 `station_lamp` 改为 5 OBJ 合成渲染：
   - 文件：
     - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjModelResourceHandler118.java`
     - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - 在原 `station_lamp_mid.obj` 基础上自动叠加：
     - `station_lamp_top.obj`
     - `station_lamp_end.obj`
     - `station_lamp_logo.obj`
     - `station_lamp_back.obj`
   - 粒子贴图按部件设置：
     - logo -> `station_lamp_logo`
     - back -> `station_lamp_back`
     - 其余 -> `station_lamp_base`

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。

## 透视未修复后的二次修正 + 车站灯贴图补全
- 用户反馈：上一版“透视仍全部未解决，车站灯模型完整但贴图不全”。
- 二次根因：
  1) 透视修复条件误写为仅 `simple_block`，而光学里大量是 `simple_glass_block`；
  2) 车站灯 OBJ 文件无可用 MTL 时，按整层 `particle` 回退会丢失 `usemtl` 分材质贴图。

### 二次修复
1. 透视修复改为“按方块 ID 直接生效，不看 kind”：
   - 文件：
     - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/content/FabricContentRegistrar.java`
     - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/content/FabricContentRegistrar.java`
2. OBJ 材质编号贴图映射能力：
   - 文件：
     - `fabric-1.18.2/.../ObjModelOption118.java`
     - `fabric-1.20.1/.../ObjModelOption120.java`
     - `fabric-1.18.2/.../ObjUnbakedModel118.java`
     - `fabric-1.20.1/.../ObjUnbakedModel120.java`
   - 新增解析 `textures` 下的材质键（如 `"0"`, `"1"`, `"2"`），并按 `materialName` 选贴图。
3. 车站灯 5 OBJ 分材质贴图补全：
   - 文件：
     - `fabric-1.18.2/.../ObjModelResourceHandler118.java`
     - `fabric-1.20.1/.../ObjModelResourceHandler120.java`
   - 在组合层中增加映射：
     - `station_lamp_mid/top/end` -> `"0": station_lamp_base`
     - `station_lamp_back` -> `"1": station_lamp_back`
     - `station_lamp_logo` -> `"2": station_lamp_logo`

### 验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。

## 三次修正（透视仍在 + 车站灯四向贴图）
- 用户反馈：透视仍存在；车站灯贴图仅一面可见，要求东西南北四面都贴。
- 新增处理：
  1) 客户端显式渲染层：
     - 在 Fabric client 初始化中，为薄片光学方块统一设置 `RenderType.cutout()`。
     - 文件：
       - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
       - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
  2) `noOcclusion` 条件修正：
     - 从“依赖 kind=simple_block”改为“按 optics 方块 ID 直接生效”。
     - 文件：
       - `fabric-1.18.2/.../FabricContentRegistrar.java`
       - `fabric-1.20.1/.../FabricContentRegistrar.java`
  3) 车站灯双面渲染与材质映射：
     - OBJ 选项新增 `double_sided`；
     - station_lamp 相关层自动开启 `double_sided=true`，避免只在单面可见；
     - 继续按 `usemtl` 编号映射纹理（0/1/2）。
     - 文件：
       - `fabric-1.18.2/.../ObjModelOption118.java`
       - `fabric-1.18.2/.../ObjUnbakedModel118.java`
       - `fabric-1.18.2/.../ObjModelResourceHandler118.java`
       - `fabric-1.20.1/.../ObjModelOption120.java`
       - `fabric-1.20.1/.../ObjUnbakedModel120.java`
       - `fabric-1.20.1/.../ObjModelResourceHandler120.java`

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。

## 四次修正（回退异常改动并重做）
- 用户反馈：三次修正后仍“透视未解、车站灯仍单向、且大字壁/导向牌模型异常”。
- 处理策略：
  1) 回退客户端 `cutout` 强制渲染层（该改动可能导致薄片模型显示异常）；
  2) 保留原方块类型创建流程（不再把薄片方块强行替换为 `new Block(...)`），仅注入非遮挡属性；
  3) station_lamp 主层（`mid`）同样加入双面与材质编号映射，不只作用于附加层。

### 关键改动
- 回退 cutout 强制：
  - `fabric-1.18.2/.../BeaconProviderFabricClient.java`
  - `fabric-1.20.1/.../BeaconProviderFabricClient.java`
- 透视修复重做（保留原 kind 分支，仅改 props）：
  - `fabric-1.18.2/.../FabricContentRegistrar.java`
  - `fabric-1.20.1/.../FabricContentRegistrar.java`
  - 薄片光学 ID 注入：
    - `noOcclusion`
    - `isViewBlocking=false`
    - `isSuffocating=false`
    - `isRedstoneConductor=false`
- station_lamp 主层补全：
  - `fabric-1.18.2/.../ObjModelResourceHandler118.java`
  - `fabric-1.20.1/.../ObjModelResourceHandler120.java`
  - 对 `station_lamp_*` 主层与附加层统一应用：
    - `double_sided=true`
    - `textures` 材质映射（0/1/2）

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。

## OBJ 光学白灯层补渲染（继续优化）
- 用户反馈：灰色底座已恢复，但记忆中应还有白色灯层，当前疑似漏渲染。
- 排查结论：
  1) 资源内存在大量成对模型：`*_base.obj` + `*_light.obj`；
  2) 现有 Fabric 覆盖 JSON 仅加载 `*_base.obj`；
  3) 当前 OBJ 资源缺少 `.mtl` 文件，单模型路径下所有面会回退到 `particle` 贴图，导致只见灰色外壳。

### 实施
1. 新增组合 Unbaked/Baked 模型（双层叠加）：
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/CombinedObjUnbakedModel120.java`
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/CombinedObjBakedModel120.java`
2. 在 OBJ handler 中自动补 light 层：
   - 文件：`fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`
   - 规则：
     - 当模型路径是 `..._base.obj` 且同目录存在 `..._light.obj` 时，
     - 自动加载第二层 light 模型并与 base 合并渲染；
     - light 层默认 `particle` 指向 `hydronyasama:block/light_base`。
3. 保持之前稳定措施不变：
   - 父链探测与 JSON 合并逻辑保留（用于规避 `BlockModel parent has to be a block model`）。

### 验证
- 执行：`./gradlew.bat :fabric-1.20.1:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。

## 五次修正（透视与车站灯四向贴图）
- 用户反馈：
  1) 薄片方块透视仍存在；
  2) 车站灯仍只有一个方向有贴图；
  3) 大字壁/导向牌模型已恢复。

### 根因分析
- 透视问题根因：`FabricContentRegistrar#createBlock` 中先给薄片方块注入 `noOcclusion/isViewBlocking=false/...`，随后又执行 `baseBlock` 的 `Properties.copy(baseBlock)`，导致前述关键属性被覆盖回默认值。
- 车站灯单向贴图根因：`station_lamp_logo.obj` 和 `station_lamp_back.obj` 本身为单方向面层，之前仅叠加一份模型；即便双面也只能覆盖前后，不会自动覆盖四个方位。

### 实施改动
1. 修复透视（属性覆盖顺序）：
   - 先处理 `baseBlock` 复制，再注入薄片 no-occlusion 属性，确保最终属性不丢失。
   - 文件：
     - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/content/FabricContentRegistrar.java`
     - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/content/FabricContentRegistrar.java`

2. 修复车站灯四向贴图：
   - OBJ 选项新增 `rotate_y`（支持 0/90/180/270 旋转）；
   - 在 `station_lamp` 组装时，对 `logo/back` 两层追加 0/90/180/270 四份旋转层；
   - 保留 `double_sided=true` 与材质编号纹理映射（1/2）。
   - 文件：
     - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjModelOption118.java`
     - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjUnbakedModel118.java`
     - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v118/ObjModelResourceHandler118.java`
     - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelOption120.java`
     - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjUnbakedModel120.java`
     - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v120/ObjModelResourceHandler120.java`

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。

## 六次修正（参考 myron-1.18 薄片渲染层策略）
- 用户建议参考 `.reference/myron-1.18`。
- 采纳点：薄片透明纹理优先走 `cutout`，避免 `translucent` 排序导致“透视到底下/透视邻块”的视觉异常。

### 实施
1. 新增薄片专用方块类（禁用遮挡/剔除）：
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/ThinPanelBlock.java`
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/ThinPanelGlassBlock.java`
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/ThinPanelBlock.java`
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/ThinPanelGlassBlock.java`
   - 关键覆盖：`skipRendering=false`、`getOcclusionShape=empty`、`getVisualShape=empty`、`propagatesSkylightDown=true`。
2. ContentRegistrar 薄片 ID 直接使用专用类：
   - `fabric-1.18.2/.../FabricContentRegistrar.java`
   - `fabric-1.20.1/.../FabricContentRegistrar.java`
3. 客户端渲染层（仅薄片 ID）改为 `RenderType.cutout()`：
   - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
   - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。

## 七次修正（文字墙/导向牌仅剩贴图）
- 用户反馈：
  1) 透视问题已消失；
  2) `发光文字墙/大字壁/导向牌(发光)` 模型仅剩贴图。

### 分析
- 这批方块模型是标准 `elements`（非 OBJ）。
- 上一版统一改为 `RenderType.cutout()` 后，半透明背景像素被 alpha test 裁切，导致视觉上“只剩文字贴图”。

### 修正
- 渲染层改为分组：
  - `cutout`（保持）：`adsorption_lamp*`, `fluorescent_lamp`, `spot_light`
  - `translucent`（改回）：
    - `text_wall`, `text_wall_lit`
    - `guide_board_np/sp/dp`, `guide_board_np/sp/dp_lit`
- 文件：
  - `fabric-1.18.2/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
  - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。

## 八次修正（文字墙/导向牌贴图误用 icon）
- 用户反馈：
  1) 透视已消失；
  2) `text_wall/text_wall_lit` 与 `guide_board_*_lit` 看起来模型正确但贴图错误，像被物品 icon 贴图覆盖。

### 分析
- 对照 `.reference/NyaSamaOptics`：同类模型主体应继续使用 `light_shell/light_base` 材质体系。
- 当前 `common` 中 lit 导向牌与文字墙模型将贴图直接绑定为 `guide_board_*_lit` / `text_wall*_lit`，导致视觉表现偏向 icon 图而非灯箱外壳材质。

### 修正
- 调整以下 block 模型贴图绑定回灯箱材质：
  - `common/src/main/resources/assets/hydronyasama/models/block/guide_board_np_lit.json`
  - `common/src/main/resources/assets/hydronyasama/models/block/guide_board_sp_lit.json`
  - `common/src/main/resources/assets/hydronyasama/models/block/guide_board_dp_lit.json`
  - `common/src/main/resources/assets/hydronyasama/models/block/text_wall.json`
  - `common/src/main/resources/assets/hydronyasama/models/block/text_wall_lit.json`
- 新值：
  - `shell -> hydronyasama:block/light_shell`
  - `base/all -> hydronyasama:block/light_base`（或 `light_shell`，按现有文件结构）

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。
- 注：并行构建时出现过一次 `shadowJar` 读取共享目录失败，已通过串行构建确认非代码问题。

## 九次修正（继续对齐 reference 的 blockstate 绑定）
- 用户反馈：5 个方块仍“贴图像 icon 覆盖”。
- 处理方向：从“仅改模型贴图字段”升级为“按 reference 结构改 blockstate 模型绑定路径”，排除误走 lit 专用模型导致的残留问题。

### 修改
- `common/src/main/resources/assets/hydronyasama/blockstates/text_wall.json`
  - `hydronyasama:block/text_wall` -> `hydronyasama:block/text_wall_tag`
- `common/src/main/resources/assets/hydronyasama/blockstates/text_wall_lit.json`
  - `hydronyasama:block/text_wall_lit` -> `hydronyasama:block/text_wall_tag`
- `common/src/main/resources/assets/hydronyasama/blockstates/guide_board_np_lit.json`
  - `hydronyasama:block/guide_board_np_lit` -> `hydronyasama:block/guide_board_np`
- `common/src/main/resources/assets/hydronyasama/blockstates/guide_board_sp_lit.json`
  - `hydronyasama:block/guide_board_sp_lit` -> `hydronyasama:block/guide_board_sp`
- `common/src/main/resources/assets/hydronyasama/blockstates/guide_board_dp_lit.json`
  - `hydronyasama:block/guide_board_dp_lit` -> `hydronyasama:block/guide_board_dp`

### 说明
- 并行构建时出现过 Gradle 资源打包文件锁，已改为串行构建验证。

### 构建验证
- `./gradlew.bat :fabric-1.18.2:build -x test` 通过。
- `./gradlew.bat :fabric-1.20.1:build -x test` 通过。
## 十次修正（文字墙模型绑定校正）
- 用户反馈：其余 5 个基本恢复，但 `大字壁(text_wall)` 与 `发光文字墙(text_wall_lit)` 疑似模型绑定错误。
- 排查结果：两个方块 blockstate 绑定不一致：
  - `text_wall -> hydronyasama:block/text_wall`
  - `text_wall_lit -> hydronyasama:block/text_wall_tag`（错误残留）
- 本轮修复：统一为各自模型，避免 lit 误走 `text_wall_tag`：
  - `common/src/main/resources/assets/hydronyasama/blockstates/text_wall.json` -> `hydronyasama:block/text_wall`
  - `common/src/main/resources/assets/hydronyasama/blockstates/text_wall_lit.json` -> `hydronyasama:block/text_wall_lit`
- 结论：是，之前 `text_wall_lit` 确实用错了模型绑定；现已修正。
## Fabric 1.16.5 OBJ 迁移（参考 FOML-1.16）
- 用户要求：继续推进 `fabric-1.16.5`，并参考 `.reference/FOML-1.16`。

### 对参考实现的借鉴与取舍
- 参考点（FOML）：
  1) 使用 `ModelLoadingRegistry` 注册 `ModelResourceProvider`；
  2) 在 provider 中拦截 `.obj` 并构造自定义 `UnbakedModel`。
- 本项目落地：
  - 继续沿用我们在 1.18.2/1.20.1 已验证稳定的“父链探测 + JSON 合并 + forge:obj 解析”方案；
  - 在 1.16.5 保持 FOML 同类注册入口（`ModelLoadingRegistry`），但能力更完整：
    - 支持 `*_base.obj + *_light.obj` 自动双层；
    - `station_lamp` 五模型组合；
    - 材质编号纹理映射（0/1/2）；
    - `double_sided` 与 `rotate_y`。

### 代码改动
1. 启用 1.16.5 OBJ 客户端引导：
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v116/ObjRenderClientBootstrap116.java`
  - 从空实现改为注册 `ObjModelResourceHandler116`。

2. 新增 v116 OBJ 渲染核心：
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v116/ObjModelResourceHandler116.java`
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v116/ObjUnbakedModel116.java`
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v116/ObjModelOption116.java`
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v116/ObjMeshBakedModel116.java`
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v116/CombinedObjUnbakedModel116.java`
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/objrender/fabric/v116/CombinedObjBakedModel116.java`

3. 1.16.5 薄片方块与渲染层策略同步（防透视）：
- 新增：
  - `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/fabric/ThinPanelBlock.java`
  - `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/fabric/ThinPanelGlassBlock.java`
- 修改：
  - `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/fabric/content/FabricContentRegistrar.java`
    - 新增 `OPTICS_THIN_NO_OCCLUSION_BLOCK_IDS`，薄片方块改走 `ThinPanel*`。
  - `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
    - 增加 optics 薄片渲染层分组：
      - `cutout`: adsorption/fluorescent/spot
      - `translucent`: text_wall/guide_board 系列

4. 1.16.5 物品 icon 覆盖清理（与 1.18/1.20 保持一致）：
- 删除 `fabric-1.16.5/src/main/resources/assets/hydronyasama/models/item/` 下 21 个 OBJ 覆盖 item 模型文件，回退使用 common 的 icon 模型。

### Java 8 兼容修复
- 1.16.5 构建目标是 Java 8，迁移时已处理：
  - `record` -> 普通类（`ObjModelOption116`）；
  - `var` -> 显式类型；
  - `String#isBlank` -> `trim().isEmpty()`；
  - `List.of/List.copyOf` -> Java 8 可用写法。

### 构建验证
- 执行：`./gradlew.bat :fabric-1.16.5:build -x test`
- 结果：通过（BUILD SUCCESSFUL）。
## 1.16.5 依赖门槛与 README 要求更新
- 修复启动依赖门槛：
  - `fabric-1.16.5/src/main/resources/fabric.mod.json`
  - `fabricloader` 依赖由 `>=0.14.23` 下调为 `>=0.14.21`。
- 文档补充运行要求与兼容提示：
  - `README.md`
  - `README_zh.md`
- 新增内容明确：
  - Fabric 1.16.5 需要 `fabric-loader >= 0.14.21`；
  - 必需安装 `fabric-api >= 0.42.0+1.16`；
  - 不应在 1.16.5 实例混放 `viafabric-mc114/mc115/mc117/mc118/mc119` 等跨版本桥接模组。
## 1.16.5 Fabric API 依赖兼容修正（整合包差异）
- 用户反馈：多个整合包中仅在加入 `hydronyasama` 后提示“fabric-api missing”，而其他模组可启动。
- 判断：部分整合包使用 Fabric API 拆分模块（不提供 `fabric-api` 总包 id），导致我们原先硬依赖 `fabric-api` 被解析为缺失。

### 修复
- `fabric-1.16.5/src/main/resources/fabric.mod.json`
  - 将 1.16.5 依赖从硬依赖 `fabric-api` 改为实际使用模块依赖：
    - `fabric-api-base`
    - `fabric-item-groups-v0`
    - `fabric-networking-api-v1`
    - `fabric-lifecycle-events-v1`
    - `fabric-blockrenderlayer-v1`
    - `fabric-model-loading-api-v1`
    - `fabric-renderer-api-v1`
    - `fabric-renderer-registries-v1`
  - `fabric-api` 调整为 `suggests`（推荐项）。

### 文档同步
- `README.md`、`README_zh.md`
  - 运行要求改为“推荐 `fabric-api` 总包，或等价拆分模块”。

### 验证
- `./gradlew.bat :fabric-1.16.5:build -x test` 通过。
- 产物内 `fabric.mod.json` 已确认包含上述新依赖结构。
## 1.16.5 依赖模块名修正（fabric-model-loading-api-v1 -> fabric-models-v0）
- 用户反馈：Loader 报缺 `fabric-model-loading-api-v1`，且该模块在 1.16.5 平台难以获取。
- 结论：这是 1.16.5 代际差异；对应模块应为 `fabric-models-v0`。
- 修复：
  - `fabric-1.16.5/src/main/resources/fabric.mod.json`
    - `fabric-model-loading-api-v1` 改为 `fabric-models-v0`。
  - `README.md`、`README_zh.md` 同步更新拆分模块列表。
- 验证：`./gradlew.bat :fabric-1.16.5:build -x test` 通过。
## 1.16.5 止血回退（解决反复重载 + 中文方格）
- 用户反馈：新包在 1.16.5 出现反复资源重载（进度条反复）与主菜单中文方格。
- 判定：与 1.20.1 早期问题同源，OBJ 模型链路触发资源重载失败，导致语言/字体回退异常。

### 本轮处理（稳定优先）
1. 暂停 1.16.5 OBJ 客户端引导：
- `fabric-1.16.5/src/main/java/cn/hydcraft/hydronyasama/fabric/BeaconProviderFabricClient.java`
- 移除 `ObjRenderClientBootstrap116` 初始化调用。

2. 删除 1.16.5 Fabric 侧 OBJ block 覆盖模型（21 个）：
- 路径：`fabric-1.16.5/src/main/resources/assets/hydronyasama/models/block/*.json`
- 目的：回退到 common 稳定模型，避免 `forge:obj` 在 1.16.5 客户端触发资源重载失败。

3. 收紧 1.16.5 依赖，避免再出现拆分模块缺失：
- `fabric-1.16.5/src/main/resources/fabric.mod.json`
- 去除当前稳定模式不必需的依赖：
  - `fabric-models-v0`
  - `fabric-renderer-api-v1`
  - `fabric-renderer-registries-v1`
- 保留最小必需模块：
  - `fabric-api-base`
  - `fabric-item-groups-v0`
  - `fabric-networking-api-v1`
  - `fabric-lifecycle-events-v1`
  - `fabric-blockrenderlayer-v1`

4. 文档同步：
- `README.md`、`README_zh.md` 的 1.16.5 拆分模块清单更新为最小稳定依赖。

### 验证
- `./gradlew.bat :fabric-1.16.5:build -x test` 通过。
