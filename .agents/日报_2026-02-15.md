# 日报 - 2026-02-15

## 今日目标
- 修复地板类方块“物品栏正常、放置后紫黑”的渲染问题。
- 修复“纵条（vstrip）碰撞箱在 x/z 方向镜像错误”的问题。

## 问题定位
- 地板问题：`common/src/main/resources/assets/hydronyasama/blockstates/*_carpet.json` 使用了旧写法 `"normal"` 作为无属性 variant key。
  在当前版本资源加载中，无属性方块应使用空键 `""`，否则放置态状态匹配失败，出现紫黑缺失模型/贴图表现。
- 纵条碰撞问题：`LegacyVStripBlock#getShape` 使用 `state.getValue(FACING).getOpposite()`，导致碰撞箱方向与模型朝向发生镜像偏移。

## 实施改动
- 将 90 个 `*_carpet.json` 的 `variants.normal` 统一改为 `variants.""`。
  关键示例：
  - `common/src/main/resources/assets/hydronyasama/blockstates/anti_static_floor_carpet.json`
  - `common/src/main/resources/assets/hydronyasama/blockstates/coarse_concrete_floor_carpet.json`
  - `common/src/main/resources/assets/hydronyasama/blockstates/plazza_floor_carpet.json`
- 修复 6 个版本/加载器的 `LegacyVStripBlock`：
  - 将 `Direction direction = state.getValue(FACING).getOpposite();`
  - 改为 `Direction direction = state.getValue(FACING);`
  涉及：Fabric/Forge 的 1.16.5、1.18.2、1.20.1。

## 验证
- 执行：`./gradlew.bat :fabric-1.20.1:spotlessJavaCheck :forge-1.20.1:spotlessJavaCheck`（通过）
- 执行：`./gradlew.bat buildTarget_1_20_1`（通过）

## 结果
- 地板类 carpet 放置态状态映射恢复正常，不再走缺失模型。
- 纵条碰撞箱方向与视觉朝向对齐，x/z 镜像问题修复。

## 进展更新（事项 1 完成）
- 事项：校正迁移报告的真实状态。
- 已更新文件：`docs/mods/MIGRATION_REPORT_CORE_BUILDING.md`
- 关键变更：
  - 将“Building 方块注册与注册桥接未完成”改为“已完成（Fabric/Forge + 1.16.5/1.18.2/1.20.1）”。
  - 保留并明确 4 项高优先待补迁：`ItemProbe`、Core `BlockEntity` 网络、NTP 链路、NSASM 真解释器。
- 下一项：开始实现 `ItemProbe + /probeCmd`。

## 进展更新（事项 2 完成）
- 事项：补迁 `ItemProbe + /probeCmd` 命令链路（Fabric/Forge + 1.16.5/1.18.2/1.20.1）。
- 实施内容：
  - 新增 `ProbeItem`（潜行右键执行保存命令）。
  - 新增 `ProbeCommandRegistrar`，注册 `/probeCmd <command...>`，将命令写入手持 Probe 的 NBT `command`。
  - `probe` 物品已接入各版本 `ContentRegistry`，并加入建筑页签。
  - 在 Fabric/Forge 服务端启动流程接入命令注册。
- 验证：
  - 执行 `./gradlew.bat buildAllTargets`（通过）。
- 备注：
  - 迁移报告已同步更新，`ItemProbe` 从“待补迁”移至“已完成（基础版）”。

## 进展更新（事项 3 完成）
- 事项：补迁 Core 通信 `BlockEntity` 网络主链路（基线版）。
- 实施内容：
  - 新增 `telecom_node` 方块与 `TelecomNodeBlockEntity`，覆盖 Fabric/Forge 的 1.16.5、1.18.2、1.20.1。
  - 完成方块实体注册桥接：
    - Fabric：`FabricContentRegistry` 增加 `telecom_node` 与 `BlockEntityType` 注册。
    - Forge：`ForgeContentRegistry` 增加 `telecom_node`、`BLOCK_ENTITY_TYPES/TILE_ENTITIES` 注册与访问器。
  - 实现交互与同步基线：潜行右键切换频道、右键切换通电、邻接同频道拓扑重建（`linkCount`）与 NBT 同步。
  - 资源补齐：新增 `blockstates/models` 的 `telecom_node` 文件，并新增中英文语言键。
  - 按需求清理旧语言资源：删除 `common/src/main/resources/assets/hydronyasama/lang/en_us.lang` 与 `zh_cn.lang`，仅保留 `json` 语言文件。
- 验证：
  - 执行 `./gradlew.bat buildAllTargets`（通过）。
- 备注：
  - 已同步更新 `docs/mods/MIGRATION_REPORT_CORE_BUILDING.md`，将 Core 通信 `BlockEntity` 网络从“待补迁”调整为“已完成（基线版）”。

## 进展更新（事项 4 进行中）
- 事项：将 `.reference/NyaSamaElectricity`、`.reference/NyaSamaOptics`、`.reference/NyaSamaTelecom` 并入当前 Architectury 多版本工程（阶段一基线）。
- 已完成：
  - 新增 common 包：
    - `cn.hydcraft.hydronyasama.electricity.content.ElectricityContent`
    - `cn.hydcraft.hydronyasama.optics.content.OpticsContent`
    - `cn.hydcraft.hydronyasama.telecom.content.TelecomContent`
  - `ModContent.bootstrap(...)` 已接入三模块。
  - `LegacyContentIds` 新增三模块 block id 列表，Forge 三版本注册器全部接入。
  - 创造模式页签已扩展至 `core/building/electricity/optics/telecom`：Fabric + Forge（1.16.5/1.18.2/1.20.1）全部接入。
  - 语言键补充：`en_us.json` 新增新页签 key（下划线与点号两套）。
  - 新增迁移报告：`docs/mods/MIGRATION_REPORT_ELECTRICITY_OPTICS_TELECOM.md`。
- 当前边界：
  - 本轮以“可编译 + 可注册 + 可进创造栏”作为基线，复杂 TileEntity/渲染/网络逻辑仍在后续阶段逐步迁移。
- 下一步：
  - 跑 `buildTarget_1_20_1` 做一次全链路编译校验，再按报错修复兼容问题。
- 编译验证：
  - `./gradlew.bat buildTarget_1_20_1` 通过。
  - `./gradlew.bat buildAllTargets` 通过（覆盖 Fabric/Forge 的 1.16.5、1.18.2、1.20.1）。
- 风险兜底：
  - 为三模块新增方块批量生成占位 `blockstates/models`（统一铁块外观），避免未迁完高精资源时出现大面积紫黑。
- 二次验证：
  - 占位资源接入后再次执行 `./gradlew.bat buildAllTargets`，通过。
## 回归修复（资源异常）
- 现象：新旧方块大面积紫黑、方块名退化为 ID、页签显示异常。
- 根因：批量生成占位资源时写入了非法 JSON（键名被写成 `""key""` 形式），导致资源加载失败。
- 修复：
  - 重写 79 组占位资源（`blockstates/models/block/models/item`）为合法 JSON。
  - 用脚本校验 `assets/hydronyasama/**/*.json`，结果 `BAD_COUNT=0`。
  - 补全新增方块语言键（`en_us.json`、`zh_cn.json`）并修正 `zh_cn` 新页签中文文案。
- 验证：
  - `./gradlew.bat buildAllTargets` 通过。
## 回归修复（创造标签页乱码 + 土木放置态紫黑）
- 根因 1：`zh_cn.json` 新增页签文案曾被错误脚本写成乱码字节。
  - 已修复 `itemGroup.hydronyasama_*` 与 `itemGroup.hydronyasama.*` 10 个键为正确中文。
- 根因 2：Fabric `ContentRegistrar` 把 `edge/railing/strip/vslab/vstrip/carpet` 错误注册成通用方块类型，导致放置态方块状态与 blockstate 不匹配（紫黑）。
  - 已改为使用 Legacy 方块实现：`LegacyEdgeBlock` / `LegacyRailingBlock` / `LegacyStripBlock` / `LegacyVSlabBlock` / `LegacyVStripBlock`，carpet 改为对应地毯方块。
  - 已将上述 Legacy 类改为 `public`（含构造器）供 `content` 包调用。
- 兼容修复：清理 Legacy Java 文件 BOM，解决 Fabric 编译报错。
- 验证：`./gradlew.bat buildAllTargets` 通过。
## 进展更新（事项 5 完成）
- 事项：修复土木紧凑家族（`square_iron_mesh_* / tarp_* / tatami_* / mesh_wire_* / dense_mesh_wire_*`）紫黑与名称显示 ID。
- 根因：
  - `BuildingContent` 对紧凑家族错误注册了完整衍生（edge/railing/roof/fence/...），与实际资源覆盖不一致，导致对应方块放置态/物品模型紫黑。
  - 紧凑家族存在 11 个基础别名键缺失（如 `block.hydronyasama.mesh_wire`），触发名称回退为 ID。
- 修复：
  - `common/.../BuildingContent.java` 增加 `isCompactFamily(...)`，对紧凑家族仅注册 `block + carpet + pane`。
  - 为 11 个基础别名补齐中英文语言键（`en_us.json`、`zh_cn.json`）。
- 验证：
  - 执行 `./gradlew.bat buildAllTargets`，通过。
  - 前述紧凑家族资源链路（blockstates/models/textures）检查无缺失。
## 进展更新（事项 6 完成）
- 事项：继续推进电信模块逻辑迁移（从“纯注册”推进到“可复用运行时核心”）。
- 新增：
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/runtime/TelecomProcessor.java`
    - 迁移了旧版 `TelecomProcessor` 的核心语义：
      - 设备注册（Rx/Tx）
      - 输入输出状态缓存（`SUP/ZERO/ONE`）
      - `set/get`（设备级与 key-bus 级）
      - `update` 轮询与分发
    - 去除了 1.12.2 的世界/TileEntity 依赖，改为回调接口（`BooleanConsumer/BooleanSupplier`）。
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/signal/SignalBoxState.java`
    - 抽离 `SignalBox` 的确定性状态机片段（源连接/反相/输出推进）。
- 说明：
  - 本次是“逻辑内核迁移”，下一步将把该内核接入具体方块实体（跨版本 Loader 层）实现可玩链路。
## 进展更新（事项 7 完成）
- 事项：继续扩展电信逻辑迁移深度，新增可独立运行的逻辑图执行器。
- 新增：
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/runtime/TelecomComponentKind.java`
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/runtime/TelecomRuntime.java`
- 能力：
  - 支持组件注册：`INPUT / OUTPUT / SIGNAL_BOX / DELAYER / TIMER`。
  - 支持 key-bus 信号聚合、外部总线输入、逐 tick 状态推进、快照导出。
  - `SIGNAL_BOX` 复用 `SignalBoxState`，`DELAYER/TIMER` 提供基础时序逻辑。
- 兼容修复：
  - `TelecomProcessor` 为兼容 Java 8，`BooleanConsumer` 替换为内部 `BoolSink`。
- 验证：
  - `./gradlew.bat buildAllTargets` 通过。

## 进展更新（事项 8 完成）
- 事项：补回并接入通信工具物品（基础可用版），避免联调前再次出现“ID名/紫黑/缺失注册”。
- 新增注册与实现：
  - 工具物品：`connector`、`dev_editor`、`ngtablet`。
  - `common`：`TelecomContent` 已新增三项 item 定义（kind：`connector_tool/dev_editor_tool/ngtablet_tool`）。
  - Fabric（1.16.5/1.18.2/1.20.1）：
    - `content/FabricContentRegistrar` 新增三种 item kind 的实例化与 telecom 页签注入。
    - 新增工具类（各版本）：`ConnectorItem`、`DevEditorItem`、`NgTabletItem`、`TelecomToolSupport`。
  - Forge（1.16.5/1.18.2/1.20.1）：
    - `ForgeContentRegistry` 新增三工具注册并加入 `HYDRONYASAMA_TELECOM` 页签。
    - 新增工具类（各版本）：`ConnectorItem`、`DevEditorItem`、`NgTabletItem`、`TelecomToolSupport`。
- 工具基础功能（当前基线）：
  - `connector`：在通信方块上记录源/目标端点，潜行右键清空连接状态（NBT）。
  - `dev_editor`：在通信方块上循环编辑模式；潜行切换反相标记（NBT）。
  - `ngtablet`：扫描通信方块并记录最后扫描端点与时间（NBT）。
- 资源修复：
  - 新增模型：`models/item/connector.json`、`models/item/dev_editor.json`、`models/item/ngtablet.json`。
  - 修正 `models/item/ngt.json` 纹理路径 `hydronyasama:items/ngt -> hydronyasama:item/ngt`。
  - 语言键补齐：
    - `item.hydronyasama.connector`
    - `item.hydronyasama.dev_editor`
    - `item.hydronyasama.ngtablet`
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 9 完成）
- 事项：推进“通信 + 光学 + 电力”可视化基线，优先解决“铁块占位/工具贴图不对/创造栏调试困难”。
- 资源迁移与修复：
  - 从 `.reference/NyaSamaTelecom` 迁入通信贴图（`textures/block` + `textures/item`），修复：
    - `connector` 使用正确贴图（`connector.png`）。
    - `dev_editor` 使用正确贴图（`dev_editor.png`）。
    - `ngtablet` 使用原版 `item_ngt.png`。
  - 从 `.reference/NyaSamaElectricity`、`.reference/NyaSamaOptics` 迁入方块贴图并建立缺名映射，补齐全部目标 ID 贴图。
  - 将电力/光学/通信三组方块模型统一重写为对应贴图立方体基线（不再使用铁块占位模型）。
- 注册扩展：
  - 新增通信物品 `nyagame_mr`（基础物品）并加入 telecom 创造页签：
    - `common/.../TelecomContent.java`
    - `forge-*/.../ForgeContentRegistry.java`
    - `fabric-*/.../FabricContentRegistrar.java`（新增 `simple_item` kind）。
  - 新增模型与语言：
    - `models/item/nyagame_mr.json`
    - `item.hydronyasama.nyagame_mr`（中英文）
- 核查结果：
  - 电力/光学/通信 ID 集合的方块贴图缺失数：`0`
  - 电力/光学/通信方块模型中的 `iron_block` 占位数：`0`
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 10 完成）
- 事项：修正“物品显示被整块方块化”问题，回到旧模组 item model 风格。
- 调整：
  - 新增 `common/src/main/resources/assets/hydronyasama/models/block/tile_icon.json`（旧版 `tile_icon` 风格）。
  - 将电力/光学/通信 79 个方块物品模型统一改为：
    - `parent: hydronyasama:block/tile_icon`
    - `textures.icon: hydronyasama:block/<id>`
  - 保留通信工具物品手持模型：
    - `connector` -> `item/connector`
    - `dev_editor` -> `item/dev_editor`
    - `ngtablet` -> `item/item_ngt`
- 结果：
  - 创造栏中三模块物品不再显示为“完整立方体方块图标”，改为旧模组风格图标展示。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 11 完成）
- 事项：恢复“放置后模型”表现，优先接通电力/光学的真实 block model 链路。
- 实施：
  - 迁入并改写命名空间（`nyasamaelectricity/nyasamaoptics -> hydronyasama`）：
    - `models/block/*.json`（含 `spot_light`、`adsorption_lamp_*`、`quad_*`、`catenary_*` 等）
    - `models/item/*.json`（参考模组 item 模型）
    - `textures/block/*.png`、`textures/item/*.png`
  - 统一重写三模块 blockstate 为现代 `variants."" -> model`，确保放置后使用对应 `models/block/<id>.json`。
  - 兼容旧模型内纹理路径，额外同步到 `textures/blocks/` 目录。
- 结果：
  - 光学/电力方块放置后已不再统一为立方体，占位模型被真实 JSON 模型替代。
  - 电力物品栏图标的“渐变异常”已按参考 item model 映射修正。
- 备注：
  - 通信模块中一部分旧版视觉效果来自 `TileEntitySpecialRenderer`（代码渲染）而非纯资源模型，后续需继续迁移 BER/渲染器链路。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 12 完成）
- 事项：修复“电力/光学/通信名称英文、创造页签中文异常、电力物品图标渐变黑底”回归问题。
- 根因：
  - `zh_cn.json` 中三模块新增键未完全回填中文（部分保留英文值）。
  - `tile_icon` 误用 `item/handheld` 作为父模型，导致部分方块物品图标出现手持阴影/黑底透视伪影。
  - Fabric 1.20 客户端渲染链改动中遗留 `javax.annotation.Nullable` 导致编译中断。
- 修复：
  - `common/src/main/resources/assets/hydronyasama/models/block/tile_icon.json`
    - `parent` 从 `item/handheld` 改为 `item/generated`。
  - `common/src/main/resources/assets/hydronyasama/lang/zh_cn.json`
    - 按 `.reference/NyaSamaElectricity/.Optics/.Telecom` 的 `en_us.lang <-> zh_cn.lang` 对照，批量回填 79 个方块键与通信物品键中文。
    - 统一修正三模块创造页签键：
      - `itemGroup.hydronyasama(_|.)electricity`
      - `itemGroup.hydronyasama(_|.)optics`
      - `itemGroup.hydronyasama(_|.)telecom`
  - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/TelecomRenderBlock.java`
    - 移除 `javax.annotation.Nullable` 依赖与注解，恢复 1.20 Fabric 编译。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。
  - 结果：三模块语言键已回到中文文案；电力物品图标黑底/渐变伪影源头已修复。

### 事项 12 勘误补充
- 发现：首次脚本写入时，少量中文常量受控制台编码影响被写成 `??`（仅 7 个键）。
- 二次修复：将受影响值改为 `\u` 转义，避免终端编码干扰。
  - `item.hydronyasama.nyagame_mr`
  - `itemGroup.hydronyasama_electricity`
  - `itemGroup.hydronyasama_optics`
  - `itemGroup.hydronyasama_telecom`
  - `itemGroup.hydronyasama.electricity`
  - `itemGroup.hydronyasama.optics`
  - `itemGroup.hydronyasama.telecom`
- 复验：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 13 完成）
- 事项：针对联调反馈修复“电力/光学/通信名称英文、光学贴图紫黑、部分方块仍为灰色方块、通信控制器面板闪烁与底座缺失”。
- 实施：
  - 语言：补齐并强制覆盖三模块缺失中文键（电力/光学/通信重点键），含：
    - `platform_plate_*`、`guide_board_*`、`signal_box_*`、`timer`、`rs_latch`、`catenary_*` 等。
  - 电力物品图标：将 28 个电力方块物品模型从 `tile_icon` 改为直接引用 `block/<id>`，避免单一平面渐变图标。
  - 光学紫黑：恢复并修复 14 个光学 block model（`adsorption_*`、`fluorescent_*`、`guide_board_*`、`led_plate`、`spot_light*`、`text_wall_tag`），补充 `shell/base` 纹理绑定，消除紫黑。
  - 光学模型补强：
    - `holo_jet_rev`、`station_lamp` 从 `cube_all` 占位改为非立方体自定义几何模型（先行可视化版本）。
    - `spot_light` 物品图标改为 `spot_light_up` 纹理。
  - 通信 BER 闪烁/底座：
    - `TelecomRenderBlock` 改为 `RenderShape.MODEL`（保留底座方块模型）。
    - BER 渲染改为单层顶面覆盖，移除双面同层绘制，降低移动时 z-fighting 闪烁。
- 风险处理：
  - 修复过程中发现 14 个光学模型文件曾被错误写成 0 字节，已从 `.reference/NyaSamaOptics` 全量回填并重新打补丁。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 14 完成）
- 事项：根据联调反馈继续修复“电力部分回退为整块方块、光学多模块仍为整块方块/贴图错误、通信控制器高度与面板表现错误”。
- 实施：
  - 电力：
    - 重建以下方块为非立方体模型：`big_pillar`、`catenary_long`、`catenary_short`、`cable_endpoint`、`cable_node`、`pillar_endpoint`、`pillar_node`。
    - 对应物品模型回到 `tile_icon`（不再显示整块立方体）。
  - 光学：
    - 将仍为 `cube_all` 的关键块改为非立方体模板：
      - `platform_plate_*`、`platform_light_*`（薄板）
      - `ad_board`、`text_wall*`（薄面板）
      - `light_beam_*`（十字光束）
      - `pillar_*`（柱体）
      - `mosaic_light_*`、`cuball_lamp`（灯体）
    - `adsorption_lamp_large/mono/multi` 与 `fluorescent_light*` 复用已可用几何并换贴图。
    - 修复 `spot_light` 物品图标纹理指向不存在资源导致的紫黑（回退到存在的 `spot_light` 纹理）。
  - 通信控制器：
    - 统一通信 17 个方块模型为半高底座（8px 高），顶部使用对应面板纹理、侧/底为白色基座。
    - 暂停 BER 顶层叠加渲染（Fabric/Forge 1.20），避免“六面面板 + 闪烁”问题；当前以模型本体为准。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 15 完成）
- 事项：按“回原项目核对”继续修复电力7件物品图标/底部透视、光学灯具贴图链路、通信控制器顶部结构。
- 对照修复（以 `.reference` 为准）：
  - 光学长明/日光/聚光链路改回共用贴图机制：`light_shell + light_base`。
  - 从参考模组补入并接入：
    - `textures/block/light_shell.png`
    - `textures/block/light_base.png`
    - 同步到 `textures/blocks/` 兼容目录。
  - `spot_light` 物品模型改回 3D block parent（不再平面 icon），避免图标错用。
- 电力7件（`big_pillar`/`catenary_long`/`catenary_short`/`cable_endpoint`/`cable_node`/`pillar_endpoint`/`pillar_node`）：
  - 物品模型统一改为 3D `parent: block/<id>`。
  - 端点/节点类模型补底座几何，降低放置后底部透视感。
- 通信控制器：
  - 保持半高底座基础上，新增“顶部凸起面板”几何层，恢复“高出一截”的立体轮廓。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 事项 16（光学资源链修复）
- 全量同步 .reference/NyaSamaOptics 的光学 OBJ 到 common 资源：models/blocks/*.obj。
- 补齐缺失贴图：station_lamp_base/back/logo、white、light_black（同步到 textures/block 与 textures/blocks）。
- 修复光学 blockstates：移除 1.12 forge_marker 旧格式，统一改为 1.20 可识别 variants。
- 修复 shell/base 贴图注入链：将默认注入改为模型内显式 textures（light_shell/light_base）。
- 已执行 ./gradlew.bat buildAllTargets，构建通过。


## 事项 17（Forge 三版本 OBJ 直连）
- 新增 Forge 1.16.5/1.18.2/1.20.1 资源覆盖：为光学关键方块写入 loader: forge:obj 模型（ad_board/cuball/fluorescent_light*/holo_jet_rev/led_plate/mosaic*/pillar*/platform*/station* 及 adsorption_lamp_*）。
- 对应物品模型统一改为 parent: hydronyasama:block/<id>，确保物品栏走同一 OBJ 形态。
- 修复打包冲突：在 uild.gradle.kts 的 	asks.withType<Jar>() 设置 duplicatesStrategy = EXCLUDE，允许 loader 模块资源覆盖 common。
- 构建验证：./gradlew.bat buildAllTargets 通过；并校验 Forge 1.20.1 成品 jar 中 ssets/hydronyasama/models/block/led_plate.json 已为 orge:obj。

## 事项 18（Fabric OBJ 中间层准备）
- Fabric 1.16.5 与 1.18.2 补充 client entrypoint：新增 BeaconProviderFabricClient，并在 abric.mod.json 注册 entrypoints.client。
- 新增光学 OBJ 映射清单：common/assets/hydronyasama/obj/optics_manifest.json，作为 Fabric/Forge 共用模型索引。
- 新增方案文档：docs/mods/Fabric-OBJ-Integration-Plan.md，说明资源包覆盖、版本适配和中间层路径。
- 全量构建校验：./gradlew.bat buildAllTargets 通过。

## 事项 19（OBJ 解析公共层）
- 在 common 新增 OBJ 解析数据结构与解析器：
  - common/src/main/java/cn/hydcraft/hydronyasama/optics/render/ObjMeshData.java
  - common/src/main/java/cn/hydcraft/hydronyasama/optics/render/ObjMeshParser.java
- 目标：后续 Fabric 1.16/1.18/1.20 共用同一解析层，只保留各版本渲染 API 适配差异。
- 兼容性处理：将 Java ecord 改为普通静态类，保证 1.16.5 Java 8 编译通过。
- 构建验证：./gradlew.bat buildAllTargets 通过。

## 事项 20（Fabric 1.20 OBJ 放置渲染打通）
- 新增 1.20 光学 OBJ 方块渲染链：
  - OpticsRenderBlock（RenderShape.INVISIBLE）
  - OpticsRenderBlockEntity 
  - OpticsRenderBlockEntityRenderer（读取 OBJ 网格并写入顶点）
- 在 FabricContentRegistrar 增加光学渲染方块集合与 optics_render 方块实体类型注册；对指定光学方块改为 OpticsRenderBlock。
- 在 Fabric 1.20 客户端入口注册 OpticsRenderBlockEntityRenderer。
- 文档中文化：docs/mods/Fabric-OBJ-Integration-Plan.md 改为中文说明。
- 验证：./gradlew.bat buildAllTargets 通过。
## 事项 21（Fabric OBJ 画质修正）
- 针对用户反馈“灰色三角/透明三角/分块阴暗”调整 1.20 OBJ 渲染器：
  - 贴图映射改为按方块 id 绑定各自贴图（不再统一 light_shell）。
  - UV 修正：V 轴翻转（OBJ -> Minecraft）。
  - 法线策略改为稳定统一法线，减少三角面明暗割裂感。
- 文件：abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 编译验证：:fabric-1.20.1:compileJava 通过。
## 事项 22（Fabric OBJ 双层修复）
- 识别关键缺陷：原光学大量模型为 ase.obj + light.obj 双层渲染，单层会出现“可见内壳三角/透明感”。
- 在 1.20 OBJ 渲染器中加入双层绘制：
  - base 使用 *_base.obj + light_shell.png
  - light 使用 *_light.obj + light_base.png
- 对无 light 层的模型保留单层渲染（如 pillar_head / station_board / station_lamp）。
- 保留 UV V 翻转与全亮度策略，减少三角面暗块。
- 文件：abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 验证：./gradlew.bat buildAllTargets 通过。
## 事项 23（闪烁与层次阴影修复）
- 修复灰色三角闪烁：对 light 层渲染添加微小外扩（scale 1.001），避免 base/light 共面 Z-Fighting。
- 增加层次阴影：
  - base 层按三角面法线计算分级明暗（方向阴影）。
  - light 层保持全亮，形成“壳体 + 发光面”层次。
- 保持双面渲染与 UV 修正。
- 文件：abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 验证：./gradlew.bat buildAllTargets 通过。

## 事项 24（回退分面阴影，稳态渲染）
- 用户反馈分面阴影与闪烁加重后，回退三角法线分级阴影方案。
- 现策略：
  - base 层：使用环境光 packedLight，颜色固定白色，不做分面明暗。
  - light 层：保持全亮  x00F000F0。
  - light 层偏移从 1.001 下调至 1.0002，减少层间错位感。
- 文件：abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 验证：:fabric-1.20.1:compileJava 通过。
## 事项 25（法线偏移消闪烁）
- 针对“全局三角闪烁”改为法线方向顶点偏移方案：
  - light 层每个顶点沿三角法线偏移  .00075（替代整体 scale）。
  - 目的：消除共面 Z-Fighting，同时避免整体外扩带来的形变闪烁。
- 渲染类型切换为 RenderType.entityCutout（开启面剔除），减少内部面可见导致的视觉噪声。
- base 层保持环境光，light 层保持全亮。
- 文件：abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 验证：./gradlew.bat buildAllTargets 通过。

## 事项 26（稳态去闪烁）
- 针对仍存在的全局闪烁与分面明暗，采用稳态策略：
  - base/light 两层统一全亮渲染（移除分面法线阴影）。
  - 对 light 层启用显式 polygonOffset(-1,-10) 深度偏移，压制共面闪烁。
  - 移除法线顶点偏移方案，避免几何微抖动副作用。
- 文件：abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 验证：:fabric-1.20.1:compileJava 通过。
## 事项 27（切换 de.javagl.obj 管线）
- 构建层：引入 de.javagl:obj:0.4.0，并加入 rchitecturyApi 以便 shadow 打包进成品。
- 渲染层：Fabric 1.20 光学渲染器切换为 de.javagl.obj 标准流程：
  - ObjReader.read -> ObjUtils.triangulate -> ObjUtils.convertToRenderable
  - 使用 ObjData 读取可渲染顶点/UV/法线数组后提交到 VertexConsumer
- 继续保留 light 层 depth bias（polygon offset）以压制共面闪烁。
- 文件：
  - uild.gradle.kts
  - abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 验证：./gradlew.bat buildAllTargets 通过。
## 事项 28（de.javagl 管线纠偏：逐面展开）
- 定位问题：将渲染数组当作顺序三角流提交，导致丢面/轮廓错误。
- 修复方案：改为基于 ObjFace 逐 face 展开顶点/UV/法线，再提交渲染。
- 保留 light 层法线方向几何偏移，减小共面闪烁。
- 文件：abric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/OpticsRenderBlockEntityRenderer.java
- 验证：./gradlew.bat buildAllTargets 通过。
### 23:58 OBJRender链路切换（Fabric）
- 按用户要求，停止光学 BER 手工三角渲染路径（已删除 1.20 旧 `OpticsRenderBlock*` 残留类，取消 BER 注册）。
- 新增统一接口：`common/src/main/java/cn/hydcraft/hydronyasama/objrender/api/ObjRenderClientBootstrap.java`。
- 新增 Fabric 实现层包：
  - `cn.hydcraft.hydronyasama.objrender.fabric.v120`：已接入 OBJ 模型资源提供器 + `forge:obj` 兼容加载 + Fabric Renderer 烘焙网格。
  - `cn.hydcraft.hydronyasama.objrender.fabric.v118`、`v116`：已接入统一 bootstrap 占位，实现链路一致。
- 三个 Fabric 版本客户端入口已接入统一 bootstrap 调用。
- 已将 Forge 的 OBJ 模型 JSON 覆盖同步到 Fabric 1.16.5/1.18.2/1.20.1：
  - `assets/hydronyasama/models/block/*.json`
  - `assets/hydronyasama/models/item/*.json`
- 新增文档：`docs/mods/OBJRender-接口说明.md`（中文）。
- 构建验证通过：
  - `:fabric-1.20.1:build -x test`
  - `:fabric-1.18.2:build -x test`
  - `:fabric-1.16.5:build -x test`
### 00:24 OBJ碰撞箱修复
- 新增 `ObjCollisionBlock`（三版本 Fabric 均已接入）：按 OBJ 顶点包围盒自动计算 `VoxelShape`，替代默认完整方块碰撞箱。
- 已在 `FabricContentRegistrar` 将光学 OBJ 方块注册为 `ObjCollisionBlock`（21 个 optics OBJ ID）。
- 技术细节：读取 `assets/hydronyasama/models/blocks/*.obj` 中 `v x y z`，按 `coord/16+0.5` 归一化并生成碰撞箱。
- 兼容修正：1.16.5 替换 `var` / `Set.of` 等高版本语法，确保 Java 8 目标可编译。
- 构建验证：`fabric-1.20.1`、`fabric-1.18.2`、`fabric-1.16.5` 均通过。
### 00:52 Forge碰撞箱同步 + 联调包导出
- Forge 1.16.5 / 1.18.2 / 1.20.1 新增 `ObjCollisionBlock`，光学 OBJ 方块碰撞箱改为按 OBJ 顶点包围盒计算。
- `ForgeContentRegistry` 已改为 optics 分流注册：仅 `forge:obj` 对应的 21 个光学方块使用 `ObjCollisionBlock`，其余保持原逻辑。
- 构建验证通过：
  - `:forge-1.20.1:build -x test`
  - `:forge-1.18.2:build -x test`
  - `:forge-1.16.5:build -x test`
  - `:fabric-1.20.1:build -x test`
- 1.20.1 Fabric 联调 jar 已重新导出。
### 01:09 CI Build Scan 开启
- 已在 `settings.gradle.kts` 启用 `com.gradle.develocity` 插件。
- 已配置 Build Scan 条款同意与发布策略：仅在 GitHub Actions 环境自动发布（`publishing.onlyIf { GITHUB_ACTIONS == true }`）。
- 本地验证：`./gradlew help` 通过，无配置错误。
