# 日报 - 2026-02-15

## 今日目标
- 修复地板类方块“物品栏正常、放置后紫黑”的渲染问题。
- 修复“纵条（vstrip）碰撞箱在 x/z 方向镜像错误”的问题。

## 问题定位
- 地板问题：`common/src/main/resources/assets/hydronyasama/blockstates/*_carpet.json` 使用了旧写法 `"normal"` 作为无属性 variant key。
  在当前版本资源加载中，无属性方块应使用空键 `""`，否则放置态状态匹配失败，出现紫黑缺失模型/贴图表现。
- 纵条碰撞问题：`LegacyVStripBlock#getShape` 使用 `state.getValue(FACING).getOpposite()`，导致碰撞箱方向与模型朝向发生镜像偏移。

## 实施改动
- 将 90 个 `*_carpet.json` 的 `variants.normal` 统一改为 `variants.""`。
  关键示例：
  - `common/src/main/resources/assets/hydronyasama/blockstates/anti_static_floor_carpet.json`
  - `common/src/main/resources/assets/hydronyasama/blockstates/coarse_concrete_floor_carpet.json`
  - `common/src/main/resources/assets/hydronyasama/blockstates/plazza_floor_carpet.json`
- 修复 6 个版本/加载器的 `LegacyVStripBlock`：
  - 将 `Direction direction = state.getValue(FACING).getOpposite();`
  - 改为 `Direction direction = state.getValue(FACING);`
  涉及：Fabric/Forge 的 1.16.5、1.18.2、1.20.1。

## 验证
- 执行：`./gradlew.bat :fabric-1.20.1:spotlessJavaCheck :forge-1.20.1:spotlessJavaCheck`（通过）
- 执行：`./gradlew.bat buildTarget_1_20_1`（通过）

## 结果
- 地板类 carpet 放置态状态映射恢复正常，不再走缺失模型。
- 纵条碰撞箱方向与视觉朝向对齐，x/z 镜像问题修复。

## 进展更新（事项 1 完成）
- 事项：校正迁移报告的真实状态。
- 已更新文件：`docs/mods/MIGRATION_REPORT_CORE_BUILDING.md`
- 关键变更：
  - 将“Building 方块注册与注册桥接未完成”改为“已完成（Fabric/Forge + 1.16.5/1.18.2/1.20.1）”。
  - 保留并明确 4 项高优先待补迁：`ItemProbe`、Core `BlockEntity` 网络、NTP 链路、NSASM 真解释器。
- 下一项：开始实现 `ItemProbe + /probeCmd`。

## 进展更新（事项 2 完成）
- 事项：补迁 `ItemProbe + /probeCmd` 命令链路（Fabric/Forge + 1.16.5/1.18.2/1.20.1）。
- 实施内容：
  - 新增 `ProbeItem`（潜行右键执行保存命令）。
  - 新增 `ProbeCommandRegistrar`，注册 `/probeCmd <command...>`，将命令写入手持 Probe 的 NBT `command`。
  - `probe` 物品已接入各版本 `ContentRegistry`，并加入建筑页签。
  - 在 Fabric/Forge 服务端启动流程接入命令注册。
- 验证：
  - 执行 `./gradlew.bat buildAllTargets`（通过）。
- 备注：
  - 迁移报告已同步更新，`ItemProbe` 从“待补迁”移至“已完成（基础版）”。

## 进展更新（事项 3 完成）
- 事项：补迁 Core 通信 `BlockEntity` 网络主链路（基线版）。
- 实施内容：
  - 新增 `telecom_node` 方块与 `TelecomNodeBlockEntity`，覆盖 Fabric/Forge 的 1.16.5、1.18.2、1.20.1。
  - 完成方块实体注册桥接：
    - Fabric：`FabricContentRegistry` 增加 `telecom_node` 与 `BlockEntityType` 注册。
    - Forge：`ForgeContentRegistry` 增加 `telecom_node`、`BLOCK_ENTITY_TYPES/TILE_ENTITIES` 注册与访问器。
  - 实现交互与同步基线：潜行右键切换频道、右键切换通电、邻接同频道拓扑重建（`linkCount`）与 NBT 同步。
  - 资源补齐：新增 `blockstates/models` 的 `telecom_node` 文件，并新增中英文语言键。
  - 按需求清理旧语言资源：删除 `common/src/main/resources/assets/hydronyasama/lang/en_us.lang` 与 `zh_cn.lang`，仅保留 `json` 语言文件。
- 验证：
  - 执行 `./gradlew.bat buildAllTargets`（通过）。
- 备注：
  - 已同步更新 `docs/mods/MIGRATION_REPORT_CORE_BUILDING.md`，将 Core 通信 `BlockEntity` 网络从“待补迁”调整为“已完成（基线版）”。

## 进展更新（事项 4 进行中）
- 事项：将 `.reference/NyaSamaElectricity`、`.reference/NyaSamaOptics`、`.reference/NyaSamaTelecom` 并入当前 Architectury 多版本工程（阶段一基线）。
- 已完成：
  - 新增 common 包：
    - `cn.hydcraft.hydronyasama.electricity.content.ElectricityContent`
    - `cn.hydcraft.hydronyasama.optics.content.OpticsContent`
    - `cn.hydcraft.hydronyasama.telecom.content.TelecomContent`
  - `ModContent.bootstrap(...)` 已接入三模块。
  - `LegacyContentIds` 新增三模块 block id 列表，Forge 三版本注册器全部接入。
  - 创造模式页签已扩展至 `core/building/electricity/optics/telecom`：Fabric + Forge（1.16.5/1.18.2/1.20.1）全部接入。
  - 语言键补充：`en_us.json` 新增新页签 key（下划线与点号两套）。
  - 新增迁移报告：`docs/mods/MIGRATION_REPORT_ELECTRICITY_OPTICS_TELECOM.md`。
- 当前边界：
  - 本轮以“可编译 + 可注册 + 可进创造栏”作为基线，复杂 TileEntity/渲染/网络逻辑仍在后续阶段逐步迁移。
- 下一步：
  - 跑 `buildTarget_1_20_1` 做一次全链路编译校验，再按报错修复兼容问题。
- 编译验证：
  - `./gradlew.bat buildTarget_1_20_1` 通过。
  - `./gradlew.bat buildAllTargets` 通过（覆盖 Fabric/Forge 的 1.16.5、1.18.2、1.20.1）。
- 风险兜底：
  - 为三模块新增方块批量生成占位 `blockstates/models`（统一铁块外观），避免未迁完高精资源时出现大面积紫黑。
- 二次验证：
  - 占位资源接入后再次执行 `./gradlew.bat buildAllTargets`，通过。
## 回归修复（资源异常）
- 现象：新旧方块大面积紫黑、方块名退化为 ID、页签显示异常。
- 根因：批量生成占位资源时写入了非法 JSON（键名被写成 `""key""` 形式），导致资源加载失败。
- 修复：
  - 重写 79 组占位资源（`blockstates/models/block/models/item`）为合法 JSON。
  - 用脚本校验 `assets/hydronyasama/**/*.json`，结果 `BAD_COUNT=0`。
  - 补全新增方块语言键（`en_us.json`、`zh_cn.json`）并修正 `zh_cn` 新页签中文文案。
- 验证：
  - `./gradlew.bat buildAllTargets` 通过。
## 回归修复（创造标签页乱码 + 土木放置态紫黑）
- 根因 1：`zh_cn.json` 新增页签文案曾被错误脚本写成乱码字节。
  - 已修复 `itemGroup.hydronyasama_*` 与 `itemGroup.hydronyasama.*` 10 个键为正确中文。
- 根因 2：Fabric `ContentRegistrar` 把 `edge/railing/strip/vslab/vstrip/carpet` 错误注册成通用方块类型，导致放置态方块状态与 blockstate 不匹配（紫黑）。
  - 已改为使用 Legacy 方块实现：`LegacyEdgeBlock` / `LegacyRailingBlock` / `LegacyStripBlock` / `LegacyVSlabBlock` / `LegacyVStripBlock`，carpet 改为对应地毯方块。
  - 已将上述 Legacy 类改为 `public`（含构造器）供 `content` 包调用。
- 兼容修复：清理 Legacy Java 文件 BOM，解决 Fabric 编译报错。
- 验证：`./gradlew.bat buildAllTargets` 通过。
## 进展更新（事项 5 完成）
- 事项：修复土木紧凑家族（`square_iron_mesh_* / tarp_* / tatami_* / mesh_wire_* / dense_mesh_wire_*`）紫黑与名称显示 ID。
- 根因：
  - `BuildingContent` 对紧凑家族错误注册了完整衍生（edge/railing/roof/fence/...），与实际资源覆盖不一致，导致对应方块放置态/物品模型紫黑。
  - 紧凑家族存在 11 个基础别名键缺失（如 `block.hydronyasama.mesh_wire`），触发名称回退为 ID。
- 修复：
  - `common/.../BuildingContent.java` 增加 `isCompactFamily(...)`，对紧凑家族仅注册 `block + carpet + pane`。
  - 为 11 个基础别名补齐中英文语言键（`en_us.json`、`zh_cn.json`）。
- 验证：
  - 执行 `./gradlew.bat buildAllTargets`，通过。
  - 前述紧凑家族资源链路（blockstates/models/textures）检查无缺失。
## 进展更新（事项 6 完成）
- 事项：继续推进电信模块逻辑迁移（从“纯注册”推进到“可复用运行时核心”）。
- 新增：
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/runtime/TelecomProcessor.java`
    - 迁移了旧版 `TelecomProcessor` 的核心语义：
      - 设备注册（Rx/Tx）
      - 输入输出状态缓存（`SUP/ZERO/ONE`）
      - `set/get`（设备级与 key-bus 级）
      - `update` 轮询与分发
    - 去除了 1.12.2 的世界/TileEntity 依赖，改为回调接口（`BooleanConsumer/BooleanSupplier`）。
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/signal/SignalBoxState.java`
    - 抽离 `SignalBox` 的确定性状态机片段（源连接/反相/输出推进）。
- 说明：
  - 本次是“逻辑内核迁移”，下一步将把该内核接入具体方块实体（跨版本 Loader 层）实现可玩链路。
## 进展更新（事项 7 完成）
- 事项：继续扩展电信逻辑迁移深度，新增可独立运行的逻辑图执行器。
- 新增：
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/runtime/TelecomComponentKind.java`
  - `common/src/main/java/cn/hydcraft/hydronyasama/telecom/runtime/TelecomRuntime.java`
- 能力：
  - 支持组件注册：`INPUT / OUTPUT / SIGNAL_BOX / DELAYER / TIMER`。
  - 支持 key-bus 信号聚合、外部总线输入、逐 tick 状态推进、快照导出。
  - `SIGNAL_BOX` 复用 `SignalBoxState`，`DELAYER/TIMER` 提供基础时序逻辑。
- 兼容修复：
  - `TelecomProcessor` 为兼容 Java 8，`BooleanConsumer` 替换为内部 `BoolSink`。
- 验证：
  - `./gradlew.bat buildAllTargets` 通过。

## 进展更新（事项 8 完成）
- 事项：补回并接入通信工具物品（基础可用版），避免联调前再次出现“ID名/紫黑/缺失注册”。
- 新增注册与实现：
  - 工具物品：`connector`、`dev_editor`、`ngtablet`。
  - `common`：`TelecomContent` 已新增三项 item 定义（kind：`connector_tool/dev_editor_tool/ngtablet_tool`）。
  - Fabric（1.16.5/1.18.2/1.20.1）：
    - `content/FabricContentRegistrar` 新增三种 item kind 的实例化与 telecom 页签注入。
    - 新增工具类（各版本）：`ConnectorItem`、`DevEditorItem`、`NgTabletItem`、`TelecomToolSupport`。
  - Forge（1.16.5/1.18.2/1.20.1）：
    - `ForgeContentRegistry` 新增三工具注册并加入 `HYDRONYASAMA_TELECOM` 页签。
    - 新增工具类（各版本）：`ConnectorItem`、`DevEditorItem`、`NgTabletItem`、`TelecomToolSupport`。
- 工具基础功能（当前基线）：
  - `connector`：在通信方块上记录源/目标端点，潜行右键清空连接状态（NBT）。
  - `dev_editor`：在通信方块上循环编辑模式；潜行切换反相标记（NBT）。
  - `ngtablet`：扫描通信方块并记录最后扫描端点与时间（NBT）。
- 资源修复：
  - 新增模型：`models/item/connector.json`、`models/item/dev_editor.json`、`models/item/ngtablet.json`。
  - 修正 `models/item/ngt.json` 纹理路径 `hydronyasama:items/ngt -> hydronyasama:item/ngt`。
  - 语言键补齐：
    - `item.hydronyasama.connector`
    - `item.hydronyasama.dev_editor`
    - `item.hydronyasama.ngtablet`
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 9 完成）
- 事项：推进“通信 + 光学 + 电力”可视化基线，优先解决“铁块占位/工具贴图不对/创造栏调试困难”。
- 资源迁移与修复：
  - 从 `.reference/NyaSamaTelecom` 迁入通信贴图（`textures/block` + `textures/item`），修复：
    - `connector` 使用正确贴图（`connector.png`）。
    - `dev_editor` 使用正确贴图（`dev_editor.png`）。
    - `ngtablet` 使用原版 `item_ngt.png`。
  - 从 `.reference/NyaSamaElectricity`、`.reference/NyaSamaOptics` 迁入方块贴图并建立缺名映射，补齐全部目标 ID 贴图。
  - 将电力/光学/通信三组方块模型统一重写为对应贴图立方体基线（不再使用铁块占位模型）。
- 注册扩展：
  - 新增通信物品 `nyagame_mr`（基础物品）并加入 telecom 创造页签：
    - `common/.../TelecomContent.java`
    - `forge-*/.../ForgeContentRegistry.java`
    - `fabric-*/.../FabricContentRegistrar.java`（新增 `simple_item` kind）。
  - 新增模型与语言：
    - `models/item/nyagame_mr.json`
    - `item.hydronyasama.nyagame_mr`（中英文）
- 核查结果：
  - 电力/光学/通信 ID 集合的方块贴图缺失数：`0`
  - 电力/光学/通信方块模型中的 `iron_block` 占位数：`0`
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 10 完成）
- 事项：修正“物品显示被整块方块化”问题，回到旧模组 item model 风格。
- 调整：
  - 新增 `common/src/main/resources/assets/hydronyasama/models/block/tile_icon.json`（旧版 `tile_icon` 风格）。
  - 将电力/光学/通信 79 个方块物品模型统一改为：
    - `parent: hydronyasama:block/tile_icon`
    - `textures.icon: hydronyasama:block/<id>`
  - 保留通信工具物品手持模型：
    - `connector` -> `item/connector`
    - `dev_editor` -> `item/dev_editor`
    - `ngtablet` -> `item/item_ngt`
- 结果：
  - 创造栏中三模块物品不再显示为“完整立方体方块图标”，改为旧模组风格图标展示。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 11 完成）
- 事项：恢复“放置后模型”表现，优先接通电力/光学的真实 block model 链路。
- 实施：
  - 迁入并改写命名空间（`nyasamaelectricity/nyasamaoptics -> hydronyasama`）：
    - `models/block/*.json`（含 `spot_light`、`adsorption_lamp_*`、`quad_*`、`catenary_*` 等）
    - `models/item/*.json`（参考模组 item 模型）
    - `textures/block/*.png`、`textures/item/*.png`
  - 统一重写三模块 blockstate 为现代 `variants."" -> model`，确保放置后使用对应 `models/block/<id>.json`。
  - 兼容旧模型内纹理路径，额外同步到 `textures/blocks/` 目录。
- 结果：
  - 光学/电力方块放置后已不再统一为立方体，占位模型被真实 JSON 模型替代。
  - 电力物品栏图标的“渐变异常”已按参考 item model 映射修正。
- 备注：
  - 通信模块中一部分旧版视觉效果来自 `TileEntitySpecialRenderer`（代码渲染）而非纯资源模型，后续需继续迁移 BER/渲染器链路。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。

## 进展更新（事项 12 完成）
- 事项：修复“电力/光学/通信名称英文、创造页签中文异常、电力物品图标渐变黑底”回归问题。
- 根因：
  - `zh_cn.json` 中三模块新增键未完全回填中文（部分保留英文值）。
  - `tile_icon` 误用 `item/handheld` 作为父模型，导致部分方块物品图标出现手持阴影/黑底透视伪影。
  - Fabric 1.20 客户端渲染链改动中遗留 `javax.annotation.Nullable` 导致编译中断。
- 修复：
  - `common/src/main/resources/assets/hydronyasama/models/block/tile_icon.json`
    - `parent` 从 `item/handheld` 改为 `item/generated`。
  - `common/src/main/resources/assets/hydronyasama/lang/zh_cn.json`
    - 按 `.reference/NyaSamaElectricity/.Optics/.Telecom` 的 `en_us.lang <-> zh_cn.lang` 对照，批量回填 79 个方块键与通信物品键中文。
    - 统一修正三模块创造页签键：
      - `itemGroup.hydronyasama(_|.)electricity`
      - `itemGroup.hydronyasama(_|.)optics`
      - `itemGroup.hydronyasama(_|.)telecom`
  - `fabric-1.20.1/src/main/java/cn/hydcraft/hydronyasama/fabric/TelecomRenderBlock.java`
    - 移除 `javax.annotation.Nullable` 依赖与注解，恢复 1.20 Fabric 编译。
- 验证：
  - 执行：`./gradlew.bat buildAllTargets`（通过）。
  - 结果：三模块语言键已回到中文文案；电力物品图标黑底/渐变伪影源头已修复。

### 事项 12 勘误补充
- 发现：首次脚本写入时，少量中文常量受控制台编码影响被写成 `??`（仅 7 个键）。
- 二次修复：将受影响值改为 `\u` 转义，避免终端编码干扰。
  - `item.hydronyasama.nyagame_mr`
  - `itemGroup.hydronyasama_electricity`
  - `itemGroup.hydronyasama_optics`
  - `itemGroup.hydronyasama_telecom`
  - `itemGroup.hydronyasama.electricity`
  - `itemGroup.hydronyasama.optics`
  - `itemGroup.hydronyasama.telecom`
- 复验：`./gradlew.bat buildAllTargets`（通过）。
